<launch>
    <arg name="robot_name" default="echo"/>
    <group ns="$(arg robot_name)">
        <param name="tf_prefix" value="$(arg robot_name)"/>

        <node name="lidar_tf" pkg="tf" type="static_transform_publisher" args="0.15 0.025 0.3 0.175 0 0 $(arg robot_name)/base_link $(arg robot_name)/lidar 100"/>

        <node name="abridge" pkg="abridge" type="abridge">
            <param name="devicePath" value="/dev/swarmie/arduino"/>
            <param name="baudRate" value="115200"/>
            <param name="timerPeriod" value="0.1"/>
        </node>

        <node name="ekf" pkg="robot_localization" type="ekf_localization_node">
            <remap from="odometry/filtered" to="abridge/odom/filtered"/>
            <param name="frequency" value="10"/>
            <param name="two_d_mode" value="true"/>
            <param name="world_frame" value="odom"/>
            <param name="imu0" value="abridge/imu"/>
            <param name="odom0" value="abridge/odom"/>
            <rosparam param="imu0_config">[false, false, false,
                                           false, false, false,
                                           false, false, false,
                                           false, false, true,
                                           false, false, false]</rosparam>
            <rosparam param="odom0_config">[false, false, false,
                                            false, false, false,
                                            true, false, false,
                                            false, false, true,
                                            false, false, false]</rosparam>
        </node>

        <node name="lidar" pkg="sweep_ros" type="sweep_node">
            <param name="serial_port" value="/dev/swarmie/scanse"/>
            <param name="serial_baudrate" value="115200"/>
            <param name="frame_id" value="$(arg robot_name)/lidar"/>
            <param name="rotation_speed" value="5"/>
            <remap from="pc2" to="lidar/cloud"/>
        </node>

        <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
            <remap from="cloud_in" to="lidar/cloud"/>
            <remap from="scan" to="lidar/scan"/>
            <rosparam>
                transform_tolerance: 0.001
                min_height: -1.0
                max_height: 1.0

                angle_min: -3.14 # -M_PI
                angle_max: 3.14 # M_PI
                angle_increment: 0.01 # 2*M_PI/360.0
                scan_time: 0.1
                range_min: 0.0
                range_max: 40.0
                use_inf: true

                # Concurrency level, affects number of pointclouds queued for processing and number of threads used
                # 0 : Detect number of cores
                # 1 : Single threaded
                # 2->inf : Parallelism level
                concurrency_level: 0
            </rosparam>
            <rosparam param="target_frame" subst_value="True">$(arg robot_name)/lidar</rosparam>
        </node>

        <node pkg="gmapping" type="slam_gmapping" name="slam">
            <param name="map_frame" value="/$(arg robot_name)/map"/>
            <param name="odom_frame" value="$(arg robot_name)/odom"/>
            <param name="base_frame" value="$(arg robot_name)/base_link"/>
            <remap from="map" to="slam/map"/>
            <remap from="map_metadata" to="slam/map_metadata"/>
            <remap from="scan" to="lidar/scan"/>
        </node>

        <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
            <rosparam file="$(find move_base_config)/config/costmap_common_params.yaml" command="load"/>
            <rosparam file="$(find move_base_config)/config/costmap_common_params.yaml" command="load"/>
            <rosparam file="$(find move_base_config)/config/local_costmap_params.yaml" command="load"/>
            <rosparam file="$(find move_base_config)/config/global_costmap_params.yaml" command="load"/>
            <rosparam file="$(find move_base_config)/config/base_local_planner_params.yaml" command="load"/>
        </node>
    </group>
</launch>
